#!/bin/bash

# Update the system
sudo apt update && sudo apt upgrade -y
sudo adduser --gecos "" --disabled-password cowrie

# Install dependencies
sudo apt install -y git python3 python3-venv python3-pip virtualenv authbind
sudo su cowrie

# Clone the Cowrie repository
git clone https://github.com/cowrie/cowrie

# Navigate to the cowrie directory
cd cowrie

# Set up a virtual environment
virtualenv --python=python3 cowrie-env
source cowrie-env/bin/activate

# Install Cowrie
pip install --upgrade pip
pip install --upgrade -r requirements.txt

exit
# Configure Cowrie to listen on port 22
sed -i 's/listen_endpoints = tcp:2222:interface=0.0.0.0/listen_endpoints = tcp:22:interface=0.0.0.0/g' etc/cowrie.cfg.dist

# Configure host SSH to listen on port 2222
sudo sed -i 's/#Port 22/Port 2222/g' /etc/ssh/sshd_config

# Restart the SSH service
sudo systemctl restart sshd

# Set up authbind to allow Cowrie to bind to low ports
sudo touch /etc/authbind/byport/22
sudo chmod 500 /etc/authbind/byport/22
sudo chown cowrie:cowrie /etc/authbind/byport/22

su cowrie
# Start Cowrie
bin/cowrie start
